import asyncio
import json
from airtable import Airtable
from typing import Dict, List, Optional

class AirtableMCPServer:
    def __init__(self, api_key: str, base_id: str, table_name: str):
        self.airtable = Airtable(base_id, table_name, api_key)
        
    async def get_pending_titles(self, limit: int = 1) -> Optional[Dict]:
        """Get titles with 'Pending' status from Airtable"""
        try:
            records = self.airtable.search('Status', 'Pending', max_records=limit)
            if records:
                record = records[0]
                return {
                    'record_id': record['id'],
                    'title': record['fields'].get('Title', ''),
                    'video_title': record['fields'].get('VideoTitle', ''),
                    'video_title_status': record['fields'].get('VideoTitleStatus', ''),
                    'status': record['fields'].get('Status', '')
                }
            return None
        except Exception as e:
            print(f"Error fetching pending titles: {e}")
            return None
    
    async def update_record_status(self, record_id: str, status: str = "Processing") -> bool:
        """Update record status - try different status values"""
        try:
            self.airtable.update(record_id, {'Status': status})
            print(f"‚úÖ Updated record {record_id} status to {status}")
            return True
        except Exception as e:
            print(f"Warning: Could not update status: {e}")
            return False
    
    async def save_generated_content(self, record_id: str, content_data: Dict) -> bool:
        """Save generated content back to Airtable using individual product columns"""
        try:
            update_fields = {}
            
            if 'keywords' in content_data:
                update_fields['KeyWords'] = ', '.join(content_data['keywords'])
            
            if 'optimized_title' in content_data:
                update_fields['VideoTitle'] = content_data['optimized_title']
            
            if 'script' in content_data and isinstance(content_data['script'], dict):
                script_data = content_data['script']
                
                if 'intro' in script_data:
                    update_fields['VideoDescription'] = script_data['intro']
                
                products = script_data.get('products', [])
                sorted_products = sorted(products, key=lambda x: x.get('rank', 0), reverse=True)
                
                for product in sorted_products:
                    rank = product.get('rank')
                    name = product.get('name', '')
                    script = product.get('script', '')
                    
                    if rank == 5:
                        update_fields['ProductNo5Title'] = name
                        update_fields['ProductNo5Description'] = script
                        if 'image_urls' in content_data and 5 in content_data['image_urls']:
                        update_fields['ProductNo5Photo'] = content_data['image_urls'][5]
                    elif rank == 4:
                        update_fields['ProductNo4Title'] = name
                        update_fields['ProductNo4Description'] = script
                        if 'image_urls' in content_data and 4 in content_data['image_urls']:
                        update_fields['ProductNo4Photo'] = content_data['image_urls'][4]
                    elif rank == 3:
                        update_fields['ProductNo3Title'] = name
                        update_fields['ProductNo3Description'] = script
                    elif rank == 2:
                        update_fields['ProductNo2Title'] = name
                        update_fields['ProductNo2Description'] = script
                    elif rank == 1:
                        update_fields['ProductNo1Title'] = name
                        update_fields['ProductNo1Description'] = script
            
            print(f"üìù Saving to fields: {list(update_fields.keys())}")
            self.airtable.update(record_id, update_fields)
            print(f"‚úÖ Saved generated content for record {record_id}")
            
            product_count = sum(1 for key in update_fields.keys() if 'ProductNo' in key and 'Title' in key)
            print(f"   üìä Saved: Keywords, VideoTitle, VideoDescription, and {product_count} products")
            
            return True
        except Exception as e:
            print(f"Error saving generated content: {e}")
            return False

async def test_airtable_server():
    with open('/app/config/api_keys.json', 'r') as f:
        config = json.load(f)
    
    server = AirtableMCPServer(
        api_key=config['airtable_api_key'],
        base_id=config['airtable_base_id'],
        table_name=config['airtable_table_name']
    )
    
    pending_title = await server.get_pending_titles()
    if pending_title:
        print("‚úÖ Found pending title:", pending_title['title'])
        print("   Video title:", pending_title['video_title'])
        print("   Status:", pending_title['status'])
    else:
        print("‚ùå No pending titles found")

if __name__ == "__main__":
    asyncio.run(test_airtable_server())
    
    async def update_record_status(self, record_id: str, status: str = "Processing") -> bool:
        """Update record status - try different status values"""
        try:
            self.airtable.update(record_id, {'Status': status})
            print(f"‚úÖ Updated record {record_id} status to {status}")
            return True
        except Exception as e:
            print(f"Warning: Could not update status: {e}")
            return False
    
    async def save_generated_content(self, record_id: str, content_data: Dict) -> bool:
        """Save generated content back to Airtable using individual product columns"""
        try:
            update_fields = {}
            
            if 'keywords' in content_data:
                update_fields['KeyWords'] = ', '.join(content_data['keywords'])
            
            if 'optimized_title' in content_data:
                update_fields['VideoTitle'] = content_data['optimized_title']
            
            if 'script' in content_data and isinstance(content_data['script'], dict):
                script_data = content_data['script']
                
                if 'intro' in script_data:
                    update_fields['VideoDescription'] = script_data['intro']
                
                products = script_data.get('products', [])
                sorted_products = sorted(products, key=lambda x: x.get('rank', 0), reverse=True)
                
                for product in sorted_products:
                    rank = product.get('rank')
                    name = product.get('name', '')
                    script = product.get('script', '')
                    
                    if rank == 5:
                        update_fields['ProductNo5Title'] = name
                        update_fields['ProductNo5Description'] = script
                    elif rank == 4:
                        update_fields['ProductNo4Title'] = name
                        update_fields['ProductNo4Description'] = script
                    elif rank == 3:
                        update_fields['ProductNo3Title'] = name
                        update_fields['ProductNo3Description'] = script
                    elif rank == 2:
                        update_fields['ProductNo2Title'] = name
                        update_fields['ProductNo2Description'] = script
                    elif rank == 1:
                        update_fields['ProductNo1Title'] = name
                        update_fields['ProductNo1Description'] = script
            
            print(f"üìù Saving to fields: {list(update_fields.keys())}")
            self.airtable.update(record_id, update_fields)
            print(f"‚úÖ Saved generated content for record {record_id}")
            
            product_count = sum(1 for key in update_fields.keys() if 'ProductNo' in key and 'Title' in key)
            print(f"   üìä Saved: Keywords, VideoTitle, VideoDescription, and {product_count} products")
            
            return True
        except Exception as e:
            print(f"Error saving generated content: {e}")
            return False

async def test_airtable_server():
    with open('/app/config/api_keys.json', 'r') as f:
        config = json.load(f)
    
    server = AirtableMCPServer(
        api_key=config['airtable_api_key'],
        base_id=config['airtable_base_id'],
        table_name=config['airtable_table_name']
    )
    
    pending_title = await server.get_pending_titles()
    if pending_title:
        print("‚úÖ Found pending title:", pending_title['title'])
    else:
        print("‚ùå No pending titles found")

if __name__ == "__main__":
    asyncio.run(test_airtable_server())
